/*Primary Analysis : 

1. Monthly Orders: Compare total orders across pre-crisis (Jan–May 2025) vs crisis 
(Jun–Sep 2025). How severe is the decline?  */

with customers_orders as (
    select
        order_period,
        count(order_id) as total_orders
    from gold.fact_orders
    group by order_period
)
select
    sum(case when order_period = 'Pre-crisis' then total_orders else 0 end) as pre_crisis_orders,
    sum(case when order_period = 'Post-crisis' then total_orders else 0 end) as crisis_orders,
    cast(
        (sum(case when order_period = 'Pre-crisis' then total_orders else 0 end) -
         sum(case when order_period = 'Post-crisis' then total_orders else 0 end)) * 100.0 /
         nullif(sum(case when order_period = 'Pre-crisis' then total_orders else 0 end),0)
        as decimal(10,2)
    ) as percentage_decline
from customers_orders;


/* 2. Which top 5 city groups experienced the highest percentage decline in orders 
during the crisis period compared to the pre-crisis period? */
with city_orders as (
    select
        customer_city,
        order_period,
        count(order_id) as total_orders
    from gold.fact_orders
    where customer_city is not null
    group by customer_city, order_period
),
pivoted as (
    select
        customer_city,
        sum(case when order_period = 'Pre-crisis' then total_orders else 0 end) as pre_crisis_orders,
        sum(case when order_period = 'Post-crisis' then total_orders else 0 end) as post_crisis_orders
    from city_orders
    group by customer_city
)
select top 5
    customer_city,
    pre_crisis_orders,
    post_crisis_orders,
    case 
        when pre_crisis_orders = 0 then null
        else cast((pre_crisis_orders - post_crisis_orders) * 100.0 / pre_crisis_orders as decimal(10,2))
    end as pct_decline
from pivoted
order by pct_decline desc;

/* 3. Among restaurants with at least 50 pre-crisis orders, which top 10 high-volume 
restaurants experienced the largest percentage decline in order counts during 
the crisis period? */

with orders_by_period as (
    select
        restaurant_name,
        order_period,
        count(order_id) as orders_count
    from gold.fact_orders
    group by restaurant_name, order_period
),
pivoted as (
    select
        restaurant_name,
        sum(case when order_period = 'Pre-crisis' then orders_count else 0 end) as pre_crisis_orders,
        sum(case when order_period = 'Post-crisis' then orders_count else 0 end) as crisis_orders
    from orders_by_period
    group by restaurant_name
),
high_volume as (
    select
        restaurant_name,
        pre_crisis_orders,
        crisis_orders
    from pivoted
    where pre_crisis_orders >= 50
)
select top 10
    restaurant_name,
    pre_crisis_orders,
    crisis_orders,
    cast(
        (pre_crisis_orders - crisis_orders) * 100.0 / pre_crisis_orders
        as decimal(10,2)
    ) as percentage_decline
from high_volume
order by percentage_decline desc;

/* 4. Cancellation Analysis: What is the cancellation rate trend pre-crisis vs post-crisis, 
and which cities are most affected? */ 

 -- Overall cancellation trend
select
    order_period,
    count(order_id) as total_orders,
    sum(case when is_cancelled = 'Y' then 1 else 0 end) as cancelled_orders,
    cast(sum(case when is_cancelled = 'Y' then 1 else 0 end) * 100.0 / count(order_id) as decimal(10,2)) as cancellation_rate_pct
from gold.fact_orders
where order_period in ('Pre-crisis','Post-crisis')
group by order_period;

-- Most affected cities
with city_rates as (
    select
        customer_city,
        order_period,
        cast(sum(case when is_cancelled = 'Y' then 1 else 0 end) * 100.0 / count(order_id) as decimal(10,2)) as cancellation_rate_pct
    from gold.fact_orders
    where customer_city is not null
      and order_period in ('Pre-crisis','Post-crisis')
      and order_timestamp between '2025-01-01' and '2025-09-30 23:59:59'
    group by customer_city, order_period
),
pivoted as (
    select
        customer_city,
        max(case when order_period = 'Pre-crisis' then cancellation_rate_pct end) as pre_crisis_rate,
        max(case when order_period = 'Post-crisis' then cancellation_rate_pct end) as post_crisis_rate
    from city_rates
    group by customer_city
)
select top 3
    customer_city,
    pre_crisis_rate,
    post_crisis_rate,
    (post_crisis_rate - pre_crisis_rate) as rate_increase
from pivoted
order by rate_increase desc;

/* 5. Ratings Fluctuation: Track average customer rating month-by-month. Which 
months saw the sharpest drop? */ 
select top 5
    *,
    rank() over(order by percentage_change) as rank_months
from (
select
    month(review_timestamp) as month_name,
    avg(rating) as current_month_rating,
    lag(avg(rating)) over(order by month(review_timestamp)) as prev_month_rating,
    coalesce((avg(rating) - lag(avg(rating)) over(order by month(review_timestamp)))/avg(rating) * 100,8) as percentage_change
from gold.fact_customer_ratings
group by month(review_timestamp)
)t


/* 6. Revenue Impact: Estimate revenue loss from pre-crisis vs crisis (based on 
subtotal, discount, and delivery fee). */

with revenue_calc as (
    select
        order_period,
        sum(subtotal_amount - discount_amount + delivery_fee) as total_revenue
    from gold.fact_orders
    where order_period in ('Pre-crisis','Post-crisis')
    group by order_period
)
select
    sum(case when order_period = 'Pre-crisis' then total_revenue end) as pre_crisis_revenue,
    sum(case when order_period = 'Post-crisis' then total_revenue end) as crisis_revenue,
    cast(
        (sum(case when order_period = 'Pre-crisis' then total_revenue end) -
         sum(case when order_period = 'Post-crisis' then total_revenue end)) as decimal(18,2)
    ) as revenue_loss,
    cast(
        (sum(case when order_period = 'Pre-crisis' then total_revenue end) -
         sum(case when order_period = 'Post-crisis' then total_revenue end)) * 100.0 /
         nullif(sum(case when order_period = 'Pre-crisis' then total_revenue end),0)
        as decimal(10,2)
    ) as percentage_revenue_decline
from revenue_calc;


/* 7. Loyalty Impact: Among customers who placed five or more orders before the 
crisis, determine how many stopped ordering during the crisis, and out of those, 
how many had an average rating above 4.5? */

with pre_crisis as (
    select 
        o.customer_id,
        count(distinct o.order_id) as pre_order_count,
        avg(r.rating) as avg_rating_pre
    from gold.fact_orders o
    left join silver.fact_ratings r
        on o.order_id = r.order_id
    where o.order_timestamp < '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'Y')
    group by o.customer_id
),
post_crisis as (
    select 
        o.customer_id,
        count(distinct o.order_id) as post_order_count
    from gold.fact_orders o
    where o.order_timestamp >= '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'Y')
    group by o.customer_id
)
select 
    count(*) as total_stopped,
    sum(case when avg_rating_pre > 4.5 then 1 else 0 end) as high_rating_stopped
from pre_crisis p
left join post_crisis q
    on p.customer_id = q.customer_id
where p.pre_order_count >= 5
  and (q.post_order_count is null or q.post_order_count = 0);


/* 8.  Customer Lifetime Decline: Which high-value customers (top 5% by total 
spend before the crisis) showed the largest drop in order frequency and ratings 
during the crisis? What common patterns (e.g., location, cuisine preference, 
delivery delays) do they share?   */

with pre_spend as (
    select 
        o.customer_id,
        sum(o.total_amount) as total_spend_pre,
        count(distinct o.order_id) as orders_pre,
        avg(r.rating) as avg_rating_pre
    from gold.fact_orders o
    left join silver.fact_ratings r 
        on o.order_id = r.order_id
    where o.order_timestamp < '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'Y')
    group by o.customer_id
),
ranked as (
    select 
        customer_id,
        total_spend_pre,
        orders_pre,
        avg_rating_pre,
        ntile(20) over (order by total_spend_pre desc) as spend_percentile
    from pre_spend
),
top_customers as (
    select * 
    from ranked
    where spend_percentile = 1   -- top 5% by spend
),
post as (
    select 
        o.customer_id,
        count(distinct o.order_id) as orders_post,
        avg(r.rating) as avg_rating_post
    from gold.fact_orders o
    left join silver.fact_ratings r 
        on o.order_id = r.order_id
    where o.order_timestamp >= '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'Y')
    group by o.customer_id
),
combined as (
    select 
        t.customer_id,
        t.total_spend_pre,
        t.orders_pre,
        coalesce(po.orders_post,0) as orders_post,
        t.avg_rating_pre,
        coalesce(po.avg_rating_post,0) as avg_rating_post,
        (t.orders_pre - coalesce(po.orders_post,0)) as order_drop,
        (t.avg_rating_pre - coalesce(po.avg_rating_post,0)) as rating_drop
    from top_customers t
    left join post po 
        on t.customer_id = po.customer_id
)
select *
from combined
order by order_drop desc, rating_drop desc;


/* The Common patterns (e.g., location, cuisine preference, 
delivery delays) they share are ; */

-- Group by city
with pre_spend as (
    select 
        o.customer_id,
        sum(o.total_amount) as total_spend_pre
    from silver.fact_orders o
    where o.order_timestamp < '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'Y')
    group by o.customer_id
),
ranked as (
    select 
        customer_id,
        total_spend_pre,
        ntile(20) over (order by total_spend_pre desc) as spend_percentile
    from pre_spend
),
top_customers as (
    select customer_id
    from ranked
    where spend_percentile = 1
),
pre as (
    select 
        o.customer_id,
        count(distinct o.order_id) as orders_pre,
        avg(r.rating) as avg_rating_pre
    from silver.fact_orders o
    left join silver.fact_ratings r on o.order_id = r.order_id
    where o.order_timestamp < '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'Y')
    group by o.customer_id
),
post as (
    select 
        o.customer_id,
        count(distinct o.order_id) as orders_post,
        avg(r.rating) as avg_rating_post
    from silver.fact_orders o
    left join silver.fact_ratings r on o.order_id = r.order_id
    where o.order_timestamp >= '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'Y')
    group by o.customer_id
),
decliners as (
    select 
        t.customer_id,
        (p.orders_pre - coalesce(po.orders_post,0)) as order_drop,
        (p.avg_rating_pre - coalesce(po.avg_rating_post,0)) as rating_drop
    from top_customers t
    join pre p on t.customer_id = p.customer_id
    left join post po on t.customer_id = po.customer_id
    where (p.orders_pre - coalesce(po.orders_post,0)) > 0
       or (p.avg_rating_pre - coalesce(po.avg_rating_post,0)) > 0
)
select 
    c.city,
    count(distinct d.customer_id) as customers_with_order_decline,
    avg(d.rating_drop) as avg_rating_drop
from decliners d
join silver.dim_customer c on d.customer_id = c.customer_id
group by c.city
order by customers_with_order_decline desc;

-- Group by Partner type 

with pre_spend as (
    select 
        o.customer_id,
        sum(o.total_amount) as total_spend_pre
    from silver.fact_orders o
    where o.order_timestamp < '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'y')
    group by o.customer_id
),
ranked as (
    select 
        customer_id,
        total_spend_pre,
        ntile(20) over (order by total_spend_pre desc) as spend_percentile
    from pre_spend
),
top_customers as (
    select customer_id
    from ranked
    where spend_percentile = 1
),
pre as (
    select 
        o.customer_id,
        count(distinct o.order_id) as orders_pre,
        avg(r.rating) as avg_rating_pre
    from silver.fact_orders o
    left join silver.fact_ratings r on o.order_id = r.order_id
    where o.order_timestamp < '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'y')
    group by o.customer_id
),
post as (
    select 
        o.customer_id,
        count(distinct o.order_id) as orders_post,
        avg(r.rating) as avg_rating_post
    from silver.fact_orders o
    left join silver.fact_ratings r on o.order_id = r.order_id
    where o.order_timestamp >= '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'y')
    group by o.customer_id
),
decliners as (
    select 
        t.customer_id,
        (p.orders_pre - coalesce(po.orders_post,0)) as order_drop,
        (p.avg_rating_pre - coalesce(po.avg_rating_post,0)) as rating_drop
    from top_customers t
    join pre p on t.customer_id = p.customer_id
    left join post po on t.customer_id = po.customer_id
    where (p.orders_pre - coalesce(po.orders_post,0)) > 0
       or (p.avg_rating_pre - coalesce(po.avg_rating_post,0)) > 0
)
select 
    r.partner_type,
    count(distinct d.customer_id) as customers_with_order_decline,
    avg(d.rating_drop) as avg_rating_drop
from decliners d
join silver.fact_orders o on d.customer_id = o.customer_id
join silver.dim_restaurant r on o.restaurant_id = r.restaurant_id
group by r.partner_type
order by customers_with_order_decline desc;

-- Group by cuisine type

with pre_spend as (
    select 
        o.customer_id,
        sum(o.total_amount) as total_spend_pre
    from silver.fact_orders o
    where o.order_timestamp < '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'y')
    group by o.customer_id
),
ranked as (
    select 
        customer_id,
        total_spend_pre,
        ntile(20) over (order by total_spend_pre desc) as spend_percentile
    from pre_spend
),
top_customers as (
    select customer_id
    from ranked
    where spend_percentile = 1
),
pre as (
    select 
        o.customer_id,
        count(distinct o.order_id) as orders_pre,
        avg(r.rating) as avg_rating_pre
    from silver.fact_orders o
    left join silver.fact_ratings r on o.order_id = r.order_id
    where o.order_timestamp < '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'y')
    group by o.customer_id
),
post as (
    select 
        o.customer_id,
        count(distinct o.order_id) as orders_post,
        avg(r.rating) as avg_rating_post
    from silver.fact_orders o
    left join silver.fact_ratings r on o.order_id = r.order_id
    where o.order_timestamp >= '2025-06-01'
      and (o.is_cancelled is null or o.is_cancelled <> 'y')
    group by o.customer_id
),
decliners as (
    select 
        t.customer_id,
        (p.orders_pre - coalesce(po.orders_post,0)) as order_drop,
        (p.avg_rating_pre - coalesce(po.avg_rating_post,0)) as rating_drop
    from top_customers t
    join pre p on t.customer_id = p.customer_id
    left join post po on t.customer_id = po.customer_id
    where (p.orders_pre - coalesce(po.orders_post,0)) > 0
       or (p.avg_rating_pre - coalesce(po.avg_rating_post,0)) > 0
)
select 
    res.cuisine_type,
    count(distinct d.customer_id) as customers_with_order_decline,
    avg(d.rating_drop) as avg_rating_drop
from decliners d
join silver.fact_orders o on d.customer_id = o.customer_id
join silver.fact_order_items oi on o.order_id = oi.order_id
join silver.dim_menu_item mi on oi.menu_item_id = mi.menu_item_id
join silver.dim_restaurant res on mi.restaurant_id = res.restaurant_id
group by res.cuisine_type
order by customers_with_order_decline desc;

/* 9. Delivery SLA: Measure average delivery time across phases. Did SLA 
      compliance worsen significantly in the crisis period?  */ 
    select 
    c.cust_period as phase,
    avg(dp.actual_delivery_time_mins) as avg_actual_delivery_time_mins,
    avg(dp.expected_delivery_time_mins) as avg_expected_delivery_time_mins,
    avg(dp.actual_delivery_time_mins - dp.expected_delivery_time_mins) as avg_delay_mins
from silver.fact_orders o
join silver.fact_delivery_performance dp 
    on o.order_id = dp.order_id
join silver.dim_customer c 
    on o.customer_id = c.customer_id
where (o.is_cancelled is null or o.is_cancelled != 'y')
  and c.cust_period is not null
  and c.cust_period <> 'N/A'
group by c.cust_period
order by c.cust_period;


/* 10. Sentiment Insights: During the crisis period, identify the most frequently 
   occurring negative keywords in customer review texts. (Hint: Use a Word Cloud 
   visual in Power BI to visualize the findings.)  */

   -- Step 1: Tokenize reviews into words and filter to post-crisis
 with tokenized as (
    select 
        r.order_id, 
        ltrim(rtrim(value)) as word
    from silver.fact_ratings r
    cross apply string_split(lower(r.review_text), ' ')
    where r.review_timestamp >= '2025-06-01'
      and r.review_text is not null
)
-- Step 2: Remove common stopwords 
, cleaned as (
    select word
    from tokenized
    where word not in (
        'the','is','a','an','and','or','of','to','for','in','on','at',
        'with','this','that','it','very','so','was','were','are','be'
    )
      and len(word) > 2   
)
-- Step 3: Filter only negative keywords if you want
, negatives as (
    select word
    from cleaned
    where word in (
        'late','delay','cold','bad','worst','stale','rude','poor','Bad taste','Food safety issue',
        'Very late','Food quality not great','Not worth the price','Average experience','Worst order',
        'tasteless','oily','missing','wrong','horrible','never','disappointed','Food quality is not good'
    )
)
-- Step 4: Count frequencies
select 
    word,
    count(*) as frequency
from negatives
group by word
order by frequency desc;

/* 11. All the reviews before the Crisis Period */

select
    case 
        when review_text like '%super fast delivery%' then 'Super fast delivery'
        when review_text like '%great taste%' then 'Great taste'
        when review_text like '%satisfied overall%' then 'Satisfied overall'
        when review_text like '%loved it%' then 'Loved it'
        when review_text like '%excellent service%' then 'Excellent service'
        when review_text like '%fresh and delicious%' then 'Fresh and delicious'
        when review_text like '%could be hotter%' then 'Could be hotter'
        when review_text like '%okay experience%' then 'Okay experience'
    end as phrase,
    count(*) as frequency
from silver.fact_ratings
where review_timestamp between '2025-01-01' and '2025-05-31'
  and review_text is not null
group by
    case 
        when review_text like '%super fast delivery%' then 'Super fast delivery'
        when review_text like '%great taste%' then 'Great taste'
        when review_text like '%satisfied overall%' then 'Satisfied overall'
        when review_text like '%loved it%' then 'Loved it'
        when review_text like '%excellent service%' then 'Excellent service'
        when review_text like '%fresh and delicious%' then 'Fresh and delicious'
        when review_text like '%could be hotter%' then 'Could be hotter'
        when review_text like '%okay experience%' then 'Okay experience'
    end
order by frequency desc

/* 12. Average sentiment score pre vs crisis */
select
    case 
        when review_timestamp between '2025-01-01' and '2025-05-31 23:59:59' then 'Pre-crisis'
        when review_timestamp >= '2025-06-01' then 'crisis'
    end as period,
    avg(sentiment_score) as avg_sentiment_score,
    count(*) as total_reviews
from QuickBite.silver.fact_ratings
where review_timestamp >= '2025-01-01'
group by case 
            when review_timestamp between '2025-01-01' and '2025-05-31 23:59:59' then 'Pre-crisis'
            when review_timestamp >= '2025-06-01' then 'crisis'
         end
order by period;

/* 13. Average Sentiment Score Drop (%) and Average Ratings Drop (%) */

with metrics as (
    select
        case 
            when review_timestamp between '2025-01-01' and '2025-05-31 23:59:59' then 'Pre-crisis'
            when review_timestamp >= '2025-06-01' then 'Post-crisis'
        end as period,
        avg(sentiment_score) as avg_sentiment_score,
        avg(rating) as avg_rating
    from QuickBite.silver.fact_ratings
    where review_timestamp >= '2025-01-01'
      and (sentiment_score is not null or rating is not null)
    group by case 
                when review_timestamp between '2025-01-01' and '2025-05-31 23:59:59' then 'Pre-crisis'
                when review_timestamp >= '2025-06-01' then 'Post-crisis'
             end
)
select
    max(case when period = 'Pre-crisis' then avg_sentiment_score end) as pre_crisis_sentiment,
    max(case when period = 'Post-crisis' then avg_sentiment_score end) as post_crisis_sentiment,
    cast(
        (max(case when period = 'Pre-crisis' then avg_sentiment_score end) -
         max(case when period = 'Post-crisis' then avg_sentiment_score end)) * 100.0 /
         nullif(max(case when period = 'Pre-crisis' then avg_sentiment_score end),0)
        as decimal(10,2)
    ) as sentiment_score_drop_pct,

    max(case when period = 'Pre-crisis' then avg_rating end) as pre_crisis_rating,
    max(case when period = 'Post-crisis' then avg_rating end) as post_crisis_rating,
    cast(
        (max(case when period = 'Pre-crisis' then avg_rating end) -
         max(case when period = 'Post-crisis' then avg_rating end)) * 100.0 /
         nullif(max(case when period = 'Pre-crisis' then avg_rating end),0)
        as decimal(10,2)
    ) as rating_drop_pct
from metrics; 

/* 13. All the reviews before the Crisis Period */

select
    case 
        when review_text like '%super fast delivery%' then 'Super fast delivery'
        when review_text like '%great taste%' then 'Great taste'
        when review_text like '%satisfied overall%' then 'Satisfied overall'
        when review_text like '%loved it%' then 'Loved it'
        when review_text like '%excellent service%' then 'Excellent service'
        when review_text like '%fresh and delicious%' then 'Fresh and delicious'
        when review_text like '%could be hotter%' then 'Could be hotter'
        when review_text like '%okay experience%' then 'Okay experience'
    end as phrase,
    count(*) as frequency
from silver.fact_ratings
where review_timestamp between '2025-01-01' and '2025-05-31'
  and review_text is not null
group by
    case 
        when review_text like '%super fast delivery%' then 'Super fast delivery'
        when review_text like '%great taste%' then 'Great taste'
        when review_text like '%satisfied overall%' then 'Satisfied overall'
        when review_text like '%loved it%' then 'Loved it'
        when review_text like '%excellent service%' then 'Excellent service'
        when review_text like '%fresh and delicious%' then 'Fresh and delicious'
        when review_text like '%could be hotter%' then 'Could be hotter'
        when review_text like '%okay experience%' then 'Okay experience'
    end
order by frequency desc

/* 14. Month on Month revenue and MoM percentage Change */

with monthly_revenue as (
select
	month(order_timestamp) as month_name,
	sum(total_amount) as current_month_revenue
from gold.fact_orders
group by month(order_timestamp)
)
select
	month_name,
	current_month_revenue,
	lag(current_month_revenue) over(order by month_name) as prev_month_revenue,
	current_month_revenue - lag(current_month_revenue) over(order by month_name) as diff_revenue,
	round(((current_month_revenue - lag(current_month_revenue) over(order by month_name))/lag(current_month_revenue) over(order by month_name)) * 100,2) as percentage_change
from monthly_revenue

         
